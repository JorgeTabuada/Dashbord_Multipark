<!DOCTYPE html>
<html>
<head>
    <title>Sincroniza√ß√£o Firebase ‚Üí Supabase</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        button { padding: 15px 30px; font-size: 18px; margin: 10px; cursor: pointer; }
        #log { background: #000; padding: 20px; margin-top: 20px; border: 1px solid #0f0; height: 400px; overflow-y: auto; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .info { color: #ff0; }
    </style>
</head>
<body>
    <h1>üî• Sincroniza√ß√£o Firebase ‚Üí Supabase</h1>
    
    <button onclick="testConnection()">1. Testar Conex√£o</button>
    <button onclick="discoverStructure()">2. Descobrir Estrutura</button>
    <button onclick="syncAll()">3. SINCRONIZAR TUDO</button>
    <button onclick="checkSupabase()">4. Verificar Supabase</button>
    
    <div id="log"></div>

    <script>
        const log = (msg, type = 'info') => {
            const div = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            div.appendChild(entry);
            div.scrollTop = div.scrollHeight;
        };

        async function testConnection() {
            log('Testando conex√£o ao Firebase...', 'info');
            try {
                const response = await fetch('/api/sync-firebase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'discover' })
                });
                const data = await response.json();
                
                if (data.structure) {
                    log('‚úÖ Conex√£o OK! Estrutura encontrada:', 'success');
                    for (const [key, value] of Object.entries(data.structure)) {
                        if (value.hasData) {
                            log(`  - ${key}: ${value.count} documentos`, 'success');
                        }
                    }
                } else {
                    log('‚ùå Erro ao conectar', 'error');
                }
            } catch (error) {
                log('‚ùå Erro: ' + error.message, 'error');
            }
        }

        async function discoverStructure() {
            log('Descobrindo estrutura completa...', 'info');
            try {
                const response = await fetch('/api/sync-firebase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'discover' })
                });
                const data = await response.json();
                
                log('Estrutura do Firebase:', 'info');
                console.log('Estrutura completa:', data.structure);
                
                for (const [collection, info] of Object.entries(data.structure || {})) {
                    if (info.hasData) {
                        log(`üìÇ ${collection}:`, 'success');
                        log(`   Documentos: ${info.count}`, 'info');
                        if (info.sample) {
                            log(`   Exemplo: ${JSON.stringify(Object.keys(info.sample)).substring(0, 100)}...`, 'info');
                        }
                        if (info.subcollections) {
                            log(`   Subcole√ß√µes: ${Object.keys(info.subcollections).join(', ')}`, 'info');
                        }
                    }
                }
                
                if (data.structure._collectionGroups) {
                    log('üìö Collection Groups encontrados:', 'success');
                    for (const [group, info] of Object.entries(data.structure._collectionGroups)) {
                        log(`   ${group}: ${info.totalFound} documentos`, 'info');
                        log(`   Caminhos: ${info.paths.join(', ')}`, 'info');
                    }
                }
            } catch (error) {
                log('‚ùå Erro: ' + error.message, 'error');
            }
        }

        async function syncAll() {
            if (!confirm('Isto vai sincronizar TODAS as reservas do Firebase para o Supabase. Continuar?')) {
                return;
            }
            
            log('üöÄ INICIANDO SINCRONIZA√á√ÉO COMPLETA...', 'info');
            
            try {
                const response = await fetch('/api/sync-firebase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'sync_all' })
                });
                
                const data = await response.json();
                
                log('=' .repeat(50), 'info');
                log('‚úÖ SINCRONIZA√á√ÉO COMPLETA!', 'success');
                log(`Total de documentos: ${data.total}`, 'success');
                log(`Sincronizados com sucesso: ${data.synced}`, 'success');
                log(`Erros: ${data.errors}`, data.errors > 0 ? 'error' : 'success');
                
                if (data.details) {
                    log('', 'info');
                    log('Detalhes por cole√ß√£o:', 'info');
                    for (const [collection, stats] of Object.entries(data.details)) {
                        log(`  ${collection}:`, 'info');
                        log(`    Total: ${stats.total || 0}`, 'info');
                        log(`    Sincronizados: ${stats.synced || 0}`, 'success');
                        log(`    Erros: ${stats.errors || 0}`, stats.errors > 0 ? 'error' : 'info');
                    }
                }
                
                if (data.errorMessages && data.errorMessages.length > 0) {
                    log('', 'info');
                    log('Mensagens de erro:', 'error');
                    data.errorMessages.forEach(msg => log(`  - ${msg}`, 'error'));
                }
                
            } catch (error) {
                log('‚ùå Erro fatal: ' + error.message, 'error');
            }
        }

        async function checkSupabase() {
            log('Verificando dados no Supabase...', 'info');
            
            // Fazer uma chamada para verificar
            try {
                const response = await fetch('/api/sync-firebase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'discover' })
                });
                
                log('Para verificar o Supabase, use o SQL Editor com:', 'info');
                log('SELECT COUNT(*) FROM reservas WHERE source = \'firebase_sync\';', 'success');
            } catch (error) {
                log('Erro: ' + error.message, 'error');
            }
        }

        // Auto-executar teste ao carregar
        window.onload = () => {
            log('Sistema de sincroniza√ß√£o pronto!', 'success');
            log('Clique nos bot√µes na ordem para sincronizar', 'info');
        };
    </script>
</body>
</html>
